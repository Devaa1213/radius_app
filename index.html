<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>CampusVibe | Connect, Create & Lead</title>

    <!-- 
        CAMPUSVIBE PRODUCTION CORE v2.7.0
        Architecture: Single-File Orchestration
        Maintainer: Senior Product Architect
        Lines: > 1500 (Production Grade)
        
        ChangeLog (v2.7.0):
        - Implemented Auto-Vanish Event Logic (Time-based filtering)
        - Added Notification Center (Modal View + Real-time Listeners)
        - Enhanced Team Inbox with Accept/Reject Workflows
        - Added Admin Event Modes (Direct vs Application)
        - Implemented Approval Workflow for Registrations
    -->

    <!-- Fix Favicon 404 -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />

    <!-- 1. EXTERNAL LIBRARIES & DEPENDENCIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Firebase Core & Service SDKs (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>

    <script>
      /**
       * TAILWIND CONFIGURATION
       * Maintaining strict visual consistency while adding utility for new logic.
       */
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: { sans: ["Outfit", "sans-serif"] },
            colors: {
              brand: {
                50: "#eef2ff",
                100: "#e0e7ff",
                500: "#6366f1",
                600: "#4f46e5",
                700: "#4338ca",
                900: "#312e81",
              },
              surface: { light: "#f8fafc", dark: "#0f172a" },
            },
            borderRadius: { "4xl": "2rem", "5xl": "2.5rem" },
            animation: {
              "pulse-slow":
                "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              float: "float 6s ease-in-out infinite",
              reveal:
                "reveal 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards",
            },
            keyframes: {
              float: {
                "0%, 100%": { transform: "translateY(0)" },
                "50%": { transform: "translateY(-20px)" },
              },
              reveal: {
                "0%": { opacity: "0", transform: "translateY(20px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
            },
          },
        },
      };
    </script>

    <style>
      /* CORE STYLES - PRESERVED & EXTENDED */
      :root {
        --primary-color: #6366f1;
        --nav-blur: 16px;
      }
      body {
        margin: 0;
        overflow-x: hidden;
        background-color: #f8fafc;
        color: #1e293b;
        transition: background-color 0.4s, color 0.4s;
      }
      .dark body {
        background-color: #0f172a;
        color: #f1f5f9;
      }
      #canvas-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.5;
        pointer-events: none;
      }
      .glass-nav {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(var(--nav-blur));
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }
      .dark .glass-nav {
        background: rgba(15, 23, 42, 0.9);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      .glass {
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.05);
      }
      .dark .glass {
        background: rgba(30, 41, 59, 0.65);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .sidebar-link {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
      }
      .sidebar-link.active {
        background-color: #e0e7ff;
        color: #4f46e5;
        border-left-color: #4f46e5;
        font-weight: 700;
      }
      .dark .sidebar-link.active {
        background-color: rgba(79, 70, 229, 0.15);
        color: #818cf8;
        border-left-color: #818cf8;
      }
      .view-section {
        display: none;
        animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .view-section.active {
        display: block;
      }
      .dashboard-tab {
        display: none;
      }
      .dashboard-tab.active {
        display: block;
      }
      @keyframes slideUpFade {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .chat-bubble {
        padding: 12px 16px;
        border-radius: 20px;
        max-width: 85%;
        margin-bottom: 12px;
        font-size: 0.95rem;
        line-height: 1.4;
        word-wrap: break-word;
      }
      .chat-sent {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }
      .chat-received {
        background: #f1f5f9;
        color: #334155;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }
      .dark .chat-received {
        background: #334155;
        color: #f8fafc;
      }
      #toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .toast {
        min-width: 300px;
        background: white;
        padding: 18px;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        animation: springIn 0.5s
          cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border-left: 6px solid;
      }
      .dark .toast {
        background: #1e293b;
        color: #f8fafc;
      }
      .toast.success {
        border-color: #10b981;
      }
      .toast.error {
        border-color: #ef4444;
      }
      .toast.info {
        border-color: #6366f1;
      }
      @keyframes springIn {
        from {
          transform: translateX(120%);
        }
        to {
          transform: translateX(0);
        }
      }
      .loader {
        border: 4px solid #e2e8f0;
        border-top: 4px solid #6366f1;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      #app-loader {
        position: fixed;
        inset: 0;
        background: #f8fafc;
        z-index: 99999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: opacity 0.6s ease;
      }
      .dark #app-loader {
        background: #0f172a;
      }
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #334155;
      }

      /* New Animated Progress Bar */
      .progress-bar-fill {
        height: 100%;

        border-radius: inherit;

        transition: width 0.6s ease-in-out;
      }
    </style>
  </head>

  <body>
    <!-- 2. GLOBAL LOADER -->
    <div id="app-loader">
      <div class="loader mb-4"></div>
      <p
        class="text-sm font-bold text-slate-500 animate-pulse uppercase tracking-[0.2em]"
      >
        Synchronizing Your Experience
      </p>
    </div>

    <!-- 3. BACKGROUND EFFECTS -->
    <div id="canvas-container"></div>
    <div id="toast-container"></div>

    <div id="app" class="relative min-h-screen flex flex-col">
      <!-- GLOBAL NAVIGATION BAR -->
      <nav
        class="glass-nav sticky top-0 z-50 transition-colors duration-300"
      >
        <div
          class="container mx-auto px-6 py-4 flex justify-between items-center"
        >
          <div
            class="flex items-center space-x-3 cursor-pointer group"
            onclick="router.navigate('events')"
          >
            <div
              class="w-11 h-11 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center text-white font-extrabold text-2xl shadow-xl transform group-hover:rotate-6 transition-transform"
            >
              CV
            </div>
            <div class="hidden sm:block">
              <h1
                class="text-2xl font-black tracking-tighter text-slate-800 dark:text-white leading-none"
              >
                Campus<span class="text-indigo-600">Vibe</span>
              </h1>
              <p
                class="text-[9px] font-black uppercase text-slate-400 tracking-widest mt-0.5"
              >
                The Innovation Ecosystem
              </p>
            </div>
          </div>

          <div
            class="flex items-center space-x-2 bg-slate-100 dark:bg-slate-800/60 p-1.5 rounded-full border border-slate-200 dark:border-slate-700"
          >
            <button
              onclick="router.navigate('events')"
              id="nav-link-events"
              class="px-5 py-2.5 rounded-full text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-700 transition"
            >
              Events
            </button>
            <button
              onclick="router.navigate('team')"
              id="nav-link-team"
              class="px-5 py-2.5 rounded-full text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-700 transition"
            >
              Team Finder
            </button>
            <button
              onclick="router.navigate('dashboard')"
              id="nav-link-dashboard"
              class="hidden px-5 py-2.5 rounded-full text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-700 transition"
            >
              Dashboard
            </button>
            <button
              onclick="router.navigate('admin')"
              id="nav-link-admin"
              class="hidden px-5 py-2.5 rounded-full text-sm font-black bg-indigo-600 text-white shadow-lg transform hover:scale-105 transition"
            >
              Admin
            </button>
          </div>

          <div class="flex items-center space-x-4">
            <!-- Task 3: Global Notification Bell -->
            <div class="relative group">
              <!-- NEW: Changed click to open Notif Modal -->
              <button
                onclick="notifLogic.openModal()"
                class="p-2.5 rounded-xl text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800 transition border border-transparent hover:border-slate-200 dark:hover:border-slate-700 relative"
              >
                <span class="text-xl">üîî</span>
                <span
                  id="notif-badge"
                  class="absolute top-1 right-1 w-4 h-4 bg-red-500 text-white text-[9px] font-black flex items-center justify-center rounded-full hidden border-2 border-white dark:border-slate-800"
                  >0</span
                >
              </button>
            </div>

            <button
              onclick="ui.toggleDark()"
              class="p-2.5 rounded-xl text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800 transition border border-transparent hover:border-slate-200 dark:hover:border-slate-700"
            >
              <span class="block dark:hidden">üåô</span>
              <span class="hidden dark:block">‚òÄÔ∏è</span>
            </button>
            <div
              id="user-logged-in"
              class="hidden flex items-center gap-3"
            >
              <div
                onclick="router.navigate('dashboard')"
                class="h-10 w-10 rounded-2xl bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300 flex items-center justify-center font-black text-lg cursor-pointer hover:scale-110 active:scale-95 transition border-2 border-indigo-200 dark:border-indigo-700 shadow-sm"
              >
                <span id="user-initial">U</span>
              </div>
              <button
                onclick="authLogic.logout()"
                class="hidden md:block text-[10px] font-black uppercase tracking-widest bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-4 py-2 rounded-xl hover:bg-red-50 hover:text-red-600 transition"
              >
                Secure Logout
              </button>
            </div>
            <button
              id="btn-login"
              onclick="ui.openModal('auth-modal')"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-7 py-3 rounded-2xl text-sm font-black shadow-2xl shadow-indigo-500/30 transform hover:-translate-y-0.5 transition"
            >
              GET STARTED
            </button>
          </div>
        </div>
      </nav>

      <main
        class="container mx-auto px-6 py-10 flex-grow relative z-10"
      >
        <!-- MODULE 1: EVENTS -->
        <section id="view-events" class="view-section active">
          <div class="max-w-4xl mx-auto text-center mb-16 mt-10">
            <span
              class="bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full text-xs font-black uppercase tracking-[0.2em] mb-4 inline-block"
              >Happening Now</span
            >
            <h2
              class="text-5xl md:text-7xl font-black text-slate-900 dark:text-white mb-6"
            >
              Experience
              <span class="text-indigo-600">Innovation.</span>
            </h2>
            <p
              class="text-xl text-slate-500 dark:text-slate-400 font-medium"
            >
              Join high-stakes hackathons and collaborative workshops.
            </p>
          </div>
          <div class="flex justify-center flex-wrap gap-3 mb-12">
            <button
              class="px-6 py-2.5 rounded-2xl bg-white dark:bg-slate-800 border dark:border-slate-700 text-sm font-bold shadow-sm hover:border-indigo-600 transition"
              onclick="eventsLogic.filter('All')"
            >
              All Categories
            </button>
            <button
              class="px-6 py-2.5 rounded-2xl bg-white dark:bg-slate-800 border dark:border-slate-700 text-sm font-bold shadow-sm hover:border-indigo-600 transition"
              onclick="eventsLogic.filter('Hackathon')"
            >
              üöÄ Hackathons
            </button>
            <button
              class="px-6 py-2.5 rounded-2xl bg-white dark:bg-slate-800 border dark:border-slate-700 text-sm font-bold shadow-sm hover:border-indigo-600 transition"
              onclick="eventsLogic.filter('Workshop')"
            >
              üõ†Ô∏è Workshops
            </button>
          </div>
          <div
            id="events-grid"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 pb-32"
          ></div>
        </section>

        <!-- MODULE 2: TEAM FINDER -->
        <section id="view-team" class="view-section">
          <div
            class="flex flex-col md:flex-row justify-between items-end mb-12 pb-8 border-b-2 border-slate-100 dark:border-slate-800"
          >
            <div>
              <h2
                class="text-4xl font-black text-slate-900 dark:text-white mb-3"
              >
                The Squad Hub
              </h2>
              <p
                class="text-lg text-slate-500 dark:text-slate-400 font-medium italic"
              >
                "Great things are never done by one person."
              </p>
            </div>
            <button
              onclick="teamLogic.openCreateModal()"
              class="bg-indigo-600 text-white px-8 py-3.5 rounded-2xl font-black shadow-xl hover:scale-105 active:scale-95 transition"
            >
              + START A SQUAD
            </button>
          </div>
          <div
            id="team-grid"
            class="grid grid-cols-1 md:grid-cols-2 gap-8 pb-32"
          ></div>
        </section>

        <!-- MODULE 3: DASHBOARD -->
        <section id="view-dashboard" class="view-section">
          <div
            class="flex flex-col lg:flex-row gap-8 min-h-[calc(100vh-200px)]"
          >
            <aside
              class="w-full lg:w-72 bg-white dark:bg-slate-800 p-6 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-700 h-fit flex flex-col gap-3"
            >
              <button
                onclick="dashboardLogic.switchTab('profile')"
                id="tab-btn-profile"
                class="sidebar-link active w-full text-left px-5 py-4 rounded-2xl text-sm font-bold flex items-center gap-4 transition-all"
              >
                <span>üë§</span> Profile
              </button>
              <button
                onclick="dashboardLogic.switchTab('tickets')"
                id="tab-btn-tickets"
                class="sidebar-link w-full text-left px-5 py-4 rounded-2xl text-sm font-bold flex items-center gap-4 transition-all"
              >
                <span>üéüÔ∏è</span> Tickets
              </button>
              <button
                onclick="dashboardLogic.switchTab('posts')"
                id="tab-btn-posts"
                class="sidebar-link w-full text-left px-5 py-4 rounded-2xl text-sm font-bold flex items-center gap-4 transition-all"
              >
                <span>üìù</span> My Posts
              </button>
              <button
                onclick="dashboardLogic.switchTab('inbox')"
                id="tab-btn-inbox"
                class="sidebar-link w-full text-left px-5 py-4 rounded-2xl text-sm font-bold flex items-center gap-4 transition-all"
              >
                <span>üì¨</span> Collaboration
              </button>
            </aside>
            <div
              class="flex-1 bg-white/40 dark:bg-slate-900/40 backdrop-blur-md border border-slate-200 dark:border-slate-700 rounded-[2.5rem] p-10 overflow-y-auto min-h-[600px] shadow-inner"
            >
              <!-- TAB: PROFILE UPGRADE -->
              <div id="dash-profile" class="dashboard-tab active">
                <div
                  class="flex flex-col md:flex-row items-center gap-8 mb-12"
                >
                  <div
                    id="dash-prof-initial-container"
                    class="w-32 h-32 rounded-[2.5rem] bg-indigo-500 flex items-center justify-center text-white text-5xl font-black shadow-2xl animate-float"
                  >
                    <span id="dash-prof-initial">U</span>
                  </div>
                  <div class="text-center md:text-left">
                    <h2
                      id="dash-prof-name"
                      class="text-4xl font-black text-slate-900 dark:text-white"
                    >
                      Student Name
                    </h2>
                    <p
                      id="dash-prof-subtitle"
                      class="text-lg text-indigo-500 font-black"
                    >
                      Dept ‚Ä¢ Year
                    </p>
                    <div
                      class="flex gap-4 mt-4 justify-center md:justify-start"
                    >
                      <div
                        class="px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-xl"
                      >
                        <p
                          class="text-[9px] font-black text-slate-400 uppercase"
                        >
                          Growth Rank
                        </p>
                        <p
                          id="prof-growth-rank"
                          class="text-sm font-bold text-slate-800 dark:text-white"
                        >
                          Emerging Talent
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8"
                >
                  <div
                    class="bg-white dark:bg-slate-800 p-8 rounded-3xl border dark:border-slate-700 shadow-sm relative overflow-hidden"
                  >
                    <h3
                      class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6"
                    >
                      Expertise System
                    </h3>
                    <div
                      id="dash-prof-skills"
                      class="flex flex-wrap gap-2 mb-6"
                    ></div>
                    <div class="pt-6 border-t dark:border-slate-700">
                      <p
                        class="text-[10px] font-black text-slate-400 uppercase mb-2"
                      >
                        Profile Integrity
                      </p>
                      <div
                        class="relative h-2 w-full bg-slate-100 dark:bg-slate-700 rounded-full"
                      >
                        <div
                          id="prof-integrity-bar"
                          class="progress-bar-fill h-full bg-indigo-500"
                          style="width: 0%"
                        ></div>
                        <span
                          id="prof-integrity-percent"
                          class="absolute right-0 top-[-20px] text-xs font-black text-slate-700 dark:text-slate-300"
                          >0%</span
                        >
                      </div>
                    </div>
                  </div>

                  <div
                    class="bg-white dark:bg-slate-800 p-8 rounded-3xl border dark:border-slate-700 shadow-sm"
                  >
                    <h3
                      class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6"
                    >
                      Activity Matrix
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                      <div
                        class="p-4 bg-slate-50 dark:bg-slate-900/50 rounded-2xl text-center"
                      >
                        <p
                          id="stat-events-joined"
                          class="text-3xl font-black text-indigo-600"
                        >
                          0
                        </p>
                        <p
                          class="text-[9px] font-bold text-slate-400 uppercase"
                        >
                          Events
                        </p>
                      </div>
                      <div
                        class="p-4 bg-slate-50 dark:bg-slate-900/50 rounded-2xl text-center"
                      >
                        <p
                          id="stat-apps-sent"
                          class="text-3xl font-black text-indigo-600"
                        >
                          0
                        </p>
                        <p
                          class="text-[9px] font-bold text-slate-400 uppercase"
                        >
                          Applications
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <button
                  onclick="profileLogic.openMyProfile()"
                  class="w-full py-5 bg-slate-900 text-white dark:bg-white dark:text-slate-900 rounded-3xl font-black transform hover:scale-[1.02] active:scale-[0.98] transition shadow-xl"
                >
                  ‚öôÔ∏è OPTIMIZE PERSONAL IDENTITY
                </button>
              </div>

              <!-- Task 2: Tickets Page Enhancement -->
              <div id="dash-tickets" class="dashboard-tab">
                <div
                  class="flex justify-between items-center mb-8 pb-4 border-b dark:border-slate-800"
                >
                  <div>
                    <h2 class="text-2xl font-black dark:text-white">
                      üéüÔ∏è My Event Registrations
                    </h2>
                    <p
                      class="text-xs font-bold text-slate-400 mt-1 uppercase tracking-wider"
                    >
                      Select an event to synchronize your digital pass
                    </p>
                  </div>
                  <span
                    class="bg-indigo-100 text-indigo-600 px-4 py-1.5 rounded-full text-[10px] font-black uppercase shadow-sm"
                    >Verified Credentials</span
                  >
                </div>
                <!-- Grid for Registered Events List -->
                <div
                  id="profile-tickets"
                  class="grid grid-cols-1 md:grid-cols-2 gap-6"
                ></div>
              </div>

              <!-- TAB: POSTS -->
              <div id="dash-posts" class="dashboard-tab">
                <h2 class="text-2xl font-black mb-8 dark:text-white">
                  üìù Active Opportunities
                </h2>
                <div id="profile-posts" class="space-y-6"></div>
              </div>

              <!-- Task 1: Collaboration Page (Inbox UI Fix - Side by Side) -->
              <div id="dash-inbox" class="dashboard-tab">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                  <!-- LEFT COLUMN: Incoming -->
                  <div class="space-y-8">
                    <div class="flex items-center gap-3 mb-2">
                      <div
                        class="w-10 h-10 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 text-lg"
                      >
                        üì•
                      </div>
                      <h2 class="text-2xl font-black dark:text-white">
                        Incoming
                      </h2>
                      <span
                        id="badge-incoming"
                        class="bg-indigo-600 text-white text-[10px] px-2.5 py-1 rounded-full font-black shadow-lg"
                        >0</span
                      >
                    </div>
                    <div id="inbox-incoming" class="space-y-4"></div>
                  </div>

                  <!-- RIGHT COLUMN: Sent -->
                  <div
                    class="space-y-8 border-t lg:border-t-0 lg:border-l lg:pl-12 border-slate-100 dark:border-slate-800"
                  >
                    <div class="flex items-center gap-3 mb-2">
                      <div
                        class="w-10 h-10 rounded-xl bg-slate-50 dark:bg-slate-800 flex items-center justify-center text-slate-400 text-lg"
                      >
                        üì§
                      </div>
                      <h2 class="text-2xl font-black dark:text-white">
                        Sent Requests
                      </h2>
                    </div>
                    <div id="inbox-sent" class="space-y-4"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- MODULE 4: ADMIN -->
        <section id="view-admin" class="view-section">
          <div
            class="glass p-10 rounded-[3rem] shadow-2xl border dark:border-slate-700 dark:bg-slate-800/90 min-h-[700px]"
          >
            <div class="flex justify-between items-center mb-12">
              <h2
                class="text-4xl font-black text-slate-800 dark:text-white"
              >
                Override Controller
              </h2>
              <div class="flex gap-4">
                <button
                  onclick="ui.openModal('scanner-modal')"
                  class="bg-white dark:bg-slate-700 text-slate-800 dark:text-white border px-6 py-3 rounded-2xl font-black text-sm"
                >
                  üì∑ ACCESS SCANNER
                </button>
                <button
                  onclick="ui.openModal('event-modal')"
                  class="bg-indigo-600 text-white px-8 py-3.5 rounded-2xl font-black text-sm shadow-xl"
                >
                  + Create Event
                </button>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
              <div
                class="bg-white dark:bg-slate-700 p-10 rounded-3xl shadow-sm border dark:border-slate-600"
              >
                <p class="text-xs font-black text-slate-400">
                  Total Events
                </p>
                <h3
                  id="stat-events"
                  class="text-5xl font-black text-indigo-600"
                >
                  0
                </h3>
              </div>
              <div
                class="bg-white dark:bg-slate-700 p-10 rounded-3xl shadow-sm border dark:border-slate-600"
              >
                <p class="text-xs font-black text-slate-400">
                  Network Posts
                </p>
                <h3
                  id="stat-posts"
                  class="text-5xl font-black text-indigo-600"
                >
                  0
                </h3>
              </div>
              <div
                class="bg-white dark:bg-slate-700 p-10 rounded-3xl shadow-sm border dark:border-slate-600"
              >
                <p class="text-xs font-black text-slate-400">
                  Database Regs
                </p>
                <h3
                  id="stat-regs"
                  class="text-5xl font-black text-indigo-600"
                >
                  0
                </h3>
              </div>
            </div>
            <div
              class="overflow-hidden bg-white dark:bg-slate-900 rounded-3xl border dark:border-slate-700"
            >
              <table class="w-full text-left">
                <thead
                  class="bg-slate-50 dark:bg-slate-800 text-[10px] font-black text-slate-500"
                >
                  <tr>
                    <th class="p-6">Campaign</th>
                    <th class="p-6">Timeline</th>
                    <th class="p-6">Network Status</th>
                    <th class="p-6 text-right">Actions</th>
                  </tr>
                </thead>
                <tbody
                  id="admin-table-body"
                  class="text-sm font-bold text-slate-700 dark:text-slate-300"
                ></tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- MODALS -->
     
    <!-- NEW: NOTIFICATION CENTER MODAL (Task 2) -->
    <div
      id="notif-modal"
      class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/60 backdrop-blur-md p-4"
    >
        <div class="glass bg-white dark:bg-slate-900 w-full max-w-lg p-8 rounded-[3rem] shadow-2xl relative flex flex-col max-h-[85vh]">
            <button
              onclick="ui.closeModal('notif-modal')"
              class="absolute top-6 right-6 text-slate-400 text-xl"
            >
              ‚úï
            </button>
            <div class="mb-6 flex justify-between items-center pr-8">
                <h3 class="text-2xl font-black dark:text-white">
                  Notifications
                </h3>
                <button onclick="notifLogic.markAllRead()" class="text-[10px] font-black text-indigo-600 uppercase tracking-widest hover:underline">
                    Mark All Read
                </button>
            </div>
            <div id="notif-list" class="flex-grow overflow-y-auto space-y-3 p-2">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- NEW: APPLICATION FORM MODAL (Admin Task) -->
    <div
      id="app-form-modal"
      class="fixed inset-0 z-[120] hidden flex items-center justify-center bg-black/70 backdrop-blur-md p-4"
    >
      <div
        class="glass bg-white dark:bg-slate-900 w-full max-w-lg p-10 rounded-[3rem] shadow-2xl relative"
      >
        <button
          onclick="ui.closeModal('app-form-modal')"
          class="absolute top-6 right-6 text-slate-400 text-xl"
        >
          ‚úï
        </button>
        <h3 class="text-3xl font-black mb-6 dark:text-white">
          Event Application
        </h3>
        <p class="text-sm text-slate-500 mb-4 italic">This event requires approval. Please provide your statement of interest.</p>
        <form onsubmit="eventsLogic.submitApplication(event)" class="space-y-4">
          <input type="hidden" id="app-event-id" />
          <textarea
            id="app-reason"
            placeholder="Why do you want to attend? (Statement of Purpose)"
            rows="4"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
            required
          ></textarea>
          <button
            type="submit"
            class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg"
          >
            SUBMIT APPLICATION
          </button>
        </form>
      </div>
    </div>

    <!-- [MODAL] AUTH -->
    <div
      id="auth-modal"
      class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/70 backdrop-blur-md p-4"
    >
      <div
        class="glass bg-white dark:bg-slate-900 w-full max-w-md p-10 rounded-[3rem] shadow-2xl relative"
      >
        <button
          onclick="ui.closeModal('auth-modal')"
          class="absolute top-6 right-6 text-slate-400 text-xl"
        >
          ‚úï
        </button>
        <h3 class="text-3xl font-black mb-6 dark:text-white">
          <div
            class="flex items-center space-x-3 cursor-pointer group"
            onclick="router.navigate('events')"
          >
            <div
              class="w-11 h-11 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center text-white font-extrabold text-2xl shadow-xl transform group-hover:rotate-6 transition-transform"
            >
              CV
            </div>
            <div class="hidden sm:block">
              <h1
                class="text-2xl font-black tracking-tighter text-slate-800 dark:text-white leading-none"
              >
                Campus<span class="text-indigo-600">Vibe</span>
              </h1>
            </div>
          </div>
        </h3>
        <form
          onsubmit="authLogic.handleSubmit(event)"
          class="space-y-4"
        >
          <input
            type="email"
            id="auth-email"
            placeholder="Campus Email"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
            required
          />

          <input
            type="password"
            id="auth-password"
            placeholder="Secure Password"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
            required
          />
          <button
            type="submit"
            class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg"
          >
            PROCEED
          </button>
        </form>
        <div class="mt-6 border-t pt-6">
          <button
            onclick="authLogic.googleLogin()"
            class="w-full bg-slate-100 dark:bg-slate-800 dark:text-white py-4 rounded-2xl font-black flex items-center justify-center gap-2"
          >
            <img
              src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
              class="w-5 h-5"
            />
            Continue With Google
          </button>
        </div>
      </div>
    </div>

    <!-- [MODAL] EVENT DETAIL -->
    <div
      id="detail-modal"
      class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/70 backdrop-blur-md p-4"
    >
      <div
        class="glass bg-white dark:bg-slate-900 w-full max-w-2xl rounded-[3rem] shadow-2xl relative overflow-hidden max-h-[90vh] flex flex-col"
      >
        <button
          onclick="ui.closeModal('detail-modal')"
          class="absolute top-6 right-6 text-white text-xl z-10 bg-black/30 p-2 rounded-full"
        >
          ‚úï
        </button>
        <div id="detail-content" class="overflow-y-auto"></div>
      </div>
    </div>

    <!-- [MODAL] POST SQUAD -->
    <div
      id="post-modal"
      class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/70 backdrop-blur-md p-4"
    >
      <div
        class="glass bg-white dark:bg-slate-900 w-full max-w-lg p-10 rounded-[3rem] shadow-2xl relative"
      >
        <button
          onclick="ui.closeModal('post-modal')"
          class="absolute top-6 right-6 text-slate-400 text-xl"
        >
          ‚úï
        </button>
        <h3 class="text-3xl font-black mb-6 dark:text-white">
          Operational Listing
        </h3>
        <form onsubmit="teamLogic.savePost(event)" class="space-y-4">
          <input type="hidden" id="post-id" />
          <input
            type="text"
            id="post-looking"
            placeholder="Specialization Required (e.g. AI Architect)"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
            required
          />
          <textarea
            id="post-desc"
            placeholder="Project Abstract & Objectives"
            rows="3"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
            required
          ></textarea>
          <input
            type="text"
            id="post-skills"
            placeholder="Skill Requirements (comma separated)"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
            required
          />
          <input
            type="text"
            id="post-contact"
            placeholder="Communication Protocol"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
            required
          />
          <button
            type="submit"
            class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg"
          >
            INITIALIZE POSTING
          </button>
        </form>
      </div>
    </div>

    <!-- [MODAL] CHAT -->
    <div
      id="chat-modal"
      class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/70 backdrop-blur-md p-4"
    >
      <div
        class="glass bg-white dark:bg-slate-900 w-full max-w-lg p-8 rounded-[3rem] shadow-2xl relative flex flex-col h-[600px]"
      >
        <button
          onclick="ui.closeModal('chat-modal')"
          class="absolute top-6 right-6 text-slate-400 text-xl"
        >
          ‚úï
        </button>
        <h3
          id="chat-title"
          class="text-2xl font-black mb-6 dark:text-white"
        >
          Encrypted Chat
        </h3>
        <div
          id="chat-messages"
          class="flex-grow overflow-y-auto flex flex-col p-4 bg-slate-50 dark:bg-slate-800 rounded-3xl mb-4"
        ></div>
        <form
          onsubmit="chatLogic.sendMessage(event)"
          class="flex gap-2"
        >
          <input
            type="text"
            id="chat-input"
            placeholder="Transmit packet..."
            class="flex-grow p-4 rounded-2xl border dark:bg-slate-700 dark:text-white"
            autocomplete="off"
          />
          <button
            type="submit"
            class="bg-indigo-600 text-white p-4 rounded-2xl font-black"
          >
            SEND
          </button>
        </form>
      </div>
    </div>

    <!-- [MODAL] PROFILE -->
    <div
      id="profile-modal"
      class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/70 backdrop-blur-md p-4"
    >
      <div
        class="glass bg-white dark:bg-slate-900 w-full max-w-lg p-10 rounded-[3rem] shadow-2xl relative max-h-[90vh] overflow-y-auto"
      >
        <button
          onclick="ui.closeModal('profile-modal')"
          class="absolute top-6 right-6 text-slate-400 text-xl"
        >
          ‚úï
        </button>
        <h3 class="text-3xl font-black mb-6 dark:text-white">
          Identity Core
        </h3>
        <form
          onsubmit="profileLogic.saveProfile(event)"
          class="space-y-4"
        >
          <input
            type="text"
            id="prof-name"
            placeholder="Legal Identity Name"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
            required
          />
          <input
            type="text"
            id="prof-dept"
            placeholder="Academic Department"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
          />
          <input
            type="text"
            id="prof-year"
            placeholder="Graduation Epoch"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
          />
          <textarea
            id="prof-interests"
            placeholder="Intellectual Interests / Biography"
            rows="3"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
          ></textarea>
          <input
            type="text"
            id="prof-skills"
            placeholder="Core Skills (comma separated)"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
          />
          <input
            type="url"
            id="prof-linkedin"
            placeholder="LinkedIn Professional Link"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
          />
          <input
            type="url"
            id="prof-github"
            placeholder="GitHub Repository Access"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
          />
          <button
            type="submit"
            class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg"
          >
            UPDATE DATABASE
          </button>
        </form>
      </div>
    </div>

    <!-- [MODAL] APPLICANT SNAPSHOT -->
    <div
      id="applicant-modal"
      class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/80 backdrop-blur-xl p-4"
    >
      <div
        class="glass bg-white dark:bg-slate-900 w-full max-w-md p-10 rounded-[3rem] shadow-2xl relative"
      >
        <button
          onclick="ui.closeModal('applicant-modal')"
          class="absolute top-6 right-6 text-slate-400 text-xl"
        >
          ‚úï
        </button>
        <div id="applicant-detail-content"></div>
      </div>
    </div>

    <!-- [MODAL] JOIN REQUEST -->
    <div
      id="join-modal"
      class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/70 backdrop-blur-md p-4"
    >
      <div
        class="glass bg-white dark:bg-slate-900 w-full max-w-lg p-10 rounded-[3rem] shadow-2xl relative"
      >
        <button
          onclick="ui.closeModal('join-modal')"
          class="absolute top-6 right-6 text-slate-400 text-xl"
        >
          ‚úï
        </button>
        <h3 class="text-3xl font-black dark:text-white mb-2">
          Collaboration Request
        </h3>
        <form
          onsubmit="teamLogic.submitJoin(event)"
          class="space-y-4"
        >
          <input type="hidden" id="join-post-id" />
          <input type="hidden" id="join-post-owner-id" />
          <input
            type="text"
            id="join-name"
            placeholder="Full Professional Name"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
            required
          />
          <input
            type="text"
            id="join-contact"
            placeholder="Contact Endpoint"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
            required
          />
          <textarea
            id="join-msg"
            placeholder="Contribution Value Proposition"
            rows="3"
            class="w-full p-4 rounded-2xl border dark:bg-slate-800 dark:text-white"
            required
          ></textarea>
          <button
            type="submit"
            class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black"
          >
            TRANSMIT PACKET
          </button>
        </form>
      </div>
    </div>

    <!-- [MODAL] TICKET VIEW (New Component for Task 2) -->
    <div
      id="ticket-modal"
      class="fixed inset-0 z-[120] hidden flex items-center justify-center bg-black/90 backdrop-blur-md p-4"
    >
      <div
        class="bg-white dark:bg-slate-900 w-full max-w-sm p-10 rounded-[4rem] shadow-2xl relative text-center border-t-[12px] border-indigo-600"
      >
        <button
          onclick="ui.closeModal('ticket-modal')"
          class="absolute top-8 right-8 text-slate-400 text-2xl"
        >
          ‚úï
        </button>
        <div class="mb-8">
          <div
            class="inline-block px-4 py-1.5 bg-indigo-50 dark:bg-indigo-900/40 text-indigo-600 rounded-full text-[9px] font-black uppercase tracking-widest mb-4"
          >
            Official Node Access
          </div>
          <h3
            id="ticket-event-name"
            class="text-3xl font-black dark:text-white leading-tight"
          >
            Syncing Node...
          </h3>
          <p
            id="ticket-event-details"
            class="text-xs font-bold text-slate-400 mt-2"
          >
            Verified Event Identity
          </p>
        </div>
        <div
          class="bg-white p-6 rounded-[3rem] shadow-2xl mb-8 inline-block border-8 border-slate-50 dark:border-slate-800"
        >
          <div
            id="ticket-qr-container"
            class="flex items-center justify-center"
          ></div>
        </div>
        <div class="space-y-2">
          <p
            id="ticket-user-name"
            class="text-lg font-black text-slate-800 dark:text-white uppercase tracking-tighter"
          >
            Innovator
          </p>
          <p
            id="ticket-id-display"
            class="text-[10px] font-mono text-indigo-500 font-bold opacity-60"
          >
            ID: ************
          </p>
        </div>
        <div
          class="mt-8 pt-8 border-t-2 border-dashed border-slate-100 dark:border-slate-800"
        >
          <p class="text-[10px] font-black text-slate-400 italic">
            "Present this node at the secure synchronization point for
            event authorization."
          </p>
        </div>
      </div>
    </div>

    <!-- [MODAL] REG VIEW -->
    <div
      id="reg-viewer-modal"
      class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/80 backdrop-blur-md p-4"
    >
      <div
        class="glass bg-white dark:bg-slate-900 w-full max-w-5xl p-10 rounded-[3rem] shadow-2xl relative max-h-[90vh] flex flex-col"
      >
        <button
          onclick="ui.closeModal('reg-viewer-modal')"
          class="absolute top-8 right-8 text-slate-400 text-2xl"
        >
          ‚úï
        </button>
        <div class="mb-10 flex justify-between items-end">
          <h3
            id="reg-event-title"
            class="text-4xl font-black dark:text-white"
          >
            Registrations
          </h3>
          <button
            id="btn-download-csv"
            class="bg-green-600 text-white px-8 py-3 rounded-2xl font-black"
          >
            EXPORT DATASET (CSV)
          </button>
        </div>
        <div
          class="overflow-y-auto rounded-2xl border dark:border-slate-700"
        >
          <table class="w-full text-left">
            <thead
              class="bg-slate-100 dark:bg-slate-800 sticky top-0"
            >
              <tr
                class="text-[10px] uppercase font-black text-slate-500"
              >
                <th class="p-6">Name</th>
                <th class="p-6">Details</th>
                <th class="p-6 text-right">Status</th>
              </tr>
            </thead>
            <tbody
              id="reg-list-body"
              class="text-xs font-bold dark:text-slate-300"
            ></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- [MODAL] SCANNER -->
    <div
      id="scanner-modal"
      class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/95 p-4"
    >
      <div
        class="bg-white dark:bg-slate-900 w-full max-w-lg p-10 rounded-[3rem] shadow-2xl relative text-center"
      >
        <button
          onclick="scannerLogic.stop(); ui.closeModal('scanner-modal');"
          class="absolute top-8 right-8 text-slate-400 text-2xl"
        >
          ‚úï
        </button>
        <h3 class="text-3xl font-black mb-6 dark:text-white">
          Security Checkpoint
        </h3>
        <div
          id="reader"
          class="rounded-3xl overflow-hidden border-8 dark:border-slate-800"
        ></div>
        <div
          id="scan-result"
          class="mt-8 p-6 rounded-2xl hidden font-black text-sm"
        ></div>
      </div>
    </div>

    <!-- EVENT modal for admin -->
    <div
      id="event-modal"
      class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"
    >
      <div
        class="glass bg-white dark:bg-slate-900 w-full max-w-lg p-6 rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto"
      >
        <button
          onclick="ui.closeModal('event-modal')"
          class="absolute top-4 right-4 text-slate-400"
        >
          ‚úï
        </button>
        <h3 class="text-xl font-bold mb-4 dark:text-white">
          Manage Event
        </h3>
        <form
          onsubmit="adminLogic.saveEvent(event)"
          class="space-y-3"
        >
          <input type="hidden" id="admin-event-id" />
          <input
            type="text"
            id="admin-title"
            placeholder="Title"
            class="w-full px-3 py-2 border rounded-lg bg-transparent dark:text-white dark:border-slate-600"
            required
          />
          <input
            type="datetime-local"
            id="admin-date"
            class="w-full px-3 py-2 border rounded-lg bg-transparent dark:text-white dark:border-slate-600"
            required
          />
          <select
            id="admin-type"
            class="w-full px-3 py-2 border rounded-lg bg-transparent dark:text-white dark:border-slate-600"
          >
            <option>Hackathon</option>
            <option>Workshop</option>
          </select>
          <input
            type="text"
            id="admin-venue"
            placeholder="Venue"
            class="w-full px-3 py-2 border rounded-lg bg-transparent dark:text-white dark:border-slate-600"
            required
          />
          <!-- NEW: Registration Mode Toggle -->
          <div class="flex items-center gap-2 p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
             <input type="checkbox" id="admin-reg-mode" class="w-5 h-5 accent-indigo-600" />
             <label for="admin-reg-mode" class="text-xs font-bold dark:text-white">Require Application/Approval Form</label>
          </div>
          <input
            type="url"
            id="admin-link"
            placeholder="Google Form (Optional)"
            class="w-full px-3 py-2 border border-indigo-200 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg dark:text-white"
          />
          <input
            type="url"
            id="admin-poster"
            placeholder="Poster URL"
            class="w-full px-3 py-2 border rounded-lg bg-transparent dark:text-white dark:border-slate-600"
          />
          <textarea
            id="admin-desc"
            placeholder="Description"
            rows="3"
            class="w-full px-3 py-2 border rounded-lg bg-transparent dark:text-white dark:border-slate-600"
            required
          ></textarea>
          <button
            type="submit"
            id="admin-save-btn"
            class="w-full bg-slate-800 text-white py-2 rounded-lg"
          >
            Save
          </button>
        </form>
      </div>
    </div>

    <script>
      /**
       * CAMPUSVIBE LOGIC ORCHESTRATION ENGINE
       * Single-source of truth for state and transitions.
       */

      // FIREBASE SETUP - DYNAMIC INJECTION
      // The server (app.py) injects these values at runtime.
      const firebaseConfig = {
        apiKey: "{{ config.apiKey }}",
        authDomain: "{{ config.authDomain }}",
        projectId: "{{ config.projectId }}",
        storageBucket: "{{ config.storageBucket }}",
        messagingSenderId: "{{ config.messagingSenderId }}",
        appId: "{{ config.appId }}",
      };
      
      // Safety Check: If keys are missing, alert the dev
      if (!firebaseConfig.apiKey) {
          console.error("CRITICAL: Firebase Config missing. Check Render Environment Variables.");
      }

      if (!firebase.apps.length)
        firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // GLOBAL PRODUCTION STATE
      const state = {
        user: null,
        isAdmin: false,
        events: [],
        posts: [],
        userRegistrations: [],
        sentRequests: [],
        incomingRequests: [],
        activeChatId: null,
        profileCompleteness: 0,
        notifCount: 0,
      };

      let unsubscribeChat = null;
      let html5QrScanner = null;

      // UI ORCHESTRATOR
      window.ui = {
        toggleDark: () =>
          document.documentElement.classList.toggle("dark"),
        openModal: (id) => {
          const el = document.getElementById(id);
          if (el) el.classList.remove("hidden");
          if (id === "scanner-modal") scannerLogic.start();
        },
        closeModal: (id) => {
          const el = document.getElementById(id);
          if (el) el.classList.add("hidden");
          if (id === "chat-modal") {
            unsubscribeChat?.();
            state.activeChatId = null;
          }
        },
        showToast: (msg, type = "info") => {
          const t = document.createElement("div");
          t.className = `toast ${type}`;
          t.innerHTML = `<div class="flex items-center gap-4"><p class="text-sm font-black">${msg}</p></div>`;
          document.getElementById("toast-container").appendChild(t);
          setTimeout(() => {
            t.style.opacity = "0";
            setTimeout(() => t.remove(), 500);
          }, 4000);
        },
        celebrate: () =>
          confetti({
            particleCount: 150,
            spread: 80,
            origin: { y: 0.6 },
          }),
        animateCounter: (id, target) => {
          const el = document.getElementById(id);
          if (!el) return;
          let current = 0;
          const increment = target / 30;
          const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
              el.innerText = Math.round(target);
              clearInterval(timer);
            } else {
              el.innerText = Math.round(current);
            }
          }, 30);
        },
      };

      // Task 2 & 3: Enhanced Notification System
      window.notifLogic = {
        lastSeen: { events: 0 },
        init: function () {
          if (!state.user) return;
          
          // 1. Personal Notifications Listener (Sub-collection)
          db.collection("users")
            .doc(state.user.uid)
            .collection("notifications")
            .orderBy("timestamp", "desc")
            .limit(20)
            .onSnapshot((s) => {
                const unread = s.docs.filter(d => !d.data().read).length;
                this.updateBadge(unread);
                this.renderList(s.docs);
            });

          // 2. Broadcast Listener (New Events / Admin Msg)
          // Listens to a shared 'broadcasts' collection
          db.collection("broadcasts")
            .orderBy("timestamp", "desc")
            .limit(5)
            .onSnapshot(s => {
                // We don't mark these as read in DB easily without writing per user.
                // We just show them in the UI mixed in.
                // Logic: If broadcast timestamp > last login, show badge? 
                // Simplified: Just render them at the top.
                this.renderBroadcasts(s.docs);
            });
        },
        updateBadge: function(count) {
            const badge = document.getElementById("notif-badge");
            if (count > 0) {
                badge.innerText = count > 9 ? "9+" : count;
                badge.classList.remove("hidden");
            } else {
                badge.classList.add("hidden");
            }
        },
        openModal: function() {
            ui.openModal("notif-modal");
        },
        renderList: function(docs) {
            // Renders personal notifications
            // We append these to a container. 
            // Note: renderBroadcasts handles clearing/prepending.
            this.personalDocs = docs;
            this.refreshUI();
        },
        renderBroadcasts: function(docs) {
            this.broadcastDocs = docs;
            this.refreshUI();
        },
        refreshUI: function() {
             const list = document.getElementById("notif-list");
             if(!list) return;
             
             let html = "";
             
             // Combine logic (simple concat for now)
             const broadcastItems = (this.broadcastDocs || []).map(d => {
                 const n = d.data();
                 return this.template(n, true);
             });
             
             const personalItems = (this.personalDocs || []).map(d => {
                 const n = d.data();
                 return this.template(n, false, d.id);
             });

             if(broadcastItems.length === 0 && personalItems.length === 0) {
                 list.innerHTML = '<p class="text-center text-slate-400 italic py-10">All caught up!</p>';
                 return;
             }
             
             list.innerHTML = broadcastItems.join("") + personalItems.join("");
        },
        template: function(n, isBroadcast, id) {
            const icon = n.type === 'event' ? 'üìÖ' : n.type === 'success' ? '‚úÖ' : n.type === 'alert' ? 'üì¢' : 'üí¨';
            const bg = n.read ? 'bg-white dark:bg-slate-800' : 'bg-indigo-50 dark:bg-slate-800 border-l-4 border-indigo-600';
            
            return `
            <div onclick="${!isBroadcast ? `notifLogic.markRead('${id}')` : ''}" class="${bg} p-4 rounded-2xl shadow-sm mb-2 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                <div class="flex gap-3">
                    <div class="text-xl">${icon}</div>
                    <div>
                        <p class="text-sm font-bold dark:text-white">${n.message}</p>
                        <p class="text-[10px] text-slate-400 font-bold uppercase mt-1">${n.timestamp?.toDate().toLocaleString() || 'Just now'}</p>
                    </div>
                </div>
            </div>`;
        },
        markRead: function(id) {
            if(!id) return;
            db.collection("users").doc(state.user.uid).collection("notifications").doc(id).update({ read: true });
        },
        markAllRead: function() {
            if(!this.personalDocs) return;
            const batch = db.batch();
            this.personalDocs.forEach(d => {
                if(!d.data().read) {
                    batch.update(d.ref, { read: true });
                }
            });
            batch.commit();
            ui.showToast("All clear", "success");
        },
        // Helper to send notification
        send: async function(uid, msg, type) {
            await db.collection("users").doc(uid).collection("notifications").add({
                message: msg,
                type: type, // 'event', 'success', 'alert', 'chat'
                read: false,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        },
        broadcast: async function(msg, type) {
            await db.collection("broadcasts").add({
                message: msg,
                type: type,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
      };

      // ADMIN POWER LOGIC
      window.adminLogic = {
        init: function () {
          if (!state.isAdmin)
            return ui.showToast(
              "Administrative Override Required",
              "error"
            );
          this.syncStats();
          this.syncEvents();
        },
        syncStats: function () {
          db.collection("events").onSnapshot(
            (s) =>
              (document.getElementById("stat-events").innerText =
                s.size)
          );
          db.collection("teamfinder").onSnapshot(
            (s) =>
              (document.getElementById("stat-posts").innerText =
                s.size)
          );
          db.collection("registrations").onSnapshot(
            (s) =>
              (document.getElementById("stat-regs").innerText =
                s.size)
          );
        },
        syncEvents: function () {
          db.collection("events")
            .orderBy("createdAt", "desc")
            .onSnapshot((s) => {
              const tbody = document.getElementById(
                "admin-table-body"
              );
              tbody.innerHTML = s.docs
                .map((d) => {
                  const e = d.data();
                  // Task 1: Check expiry for Admin View (Visual indicator only)
                  const isExpired = new Date(e.date) < new Date();
                  
                  return `
                        <tr class="border-b dark:border-slate-800 hover:bg-slate-50/50 dark:hover:bg-slate-800/50 transition">
                            <td class="p-6"><div><p class="font-black ${isExpired ? 'text-slate-400 line-through' : ''}">${
                              e.title
                            }</p><p class="text-[9px] uppercase tracking-tighter opacity-60">${
                    e.type
                  } ${e.regType === 'application' ? '‚Ä¢ APPROVAL REQ' : ''}</p></div></td>
                            <td class="p-6 text-xs text-slate-500">${
                              e.date ? new Date(e.date).toLocaleString() : "UNSCHEDULED"
                            }</td>
                            <td class="p-6"><span class="${isExpired ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-700'} px-2 py-1 rounded-lg text-[9px] font-black uppercase">${isExpired ? 'EXPIRED' : 'ACTIVE'}</span></td>
                            <td class="p-6 text-right flex justify-end gap-2">
                                <button onclick="adminLogic.loadRegistrations('${
                                  d.id
                                }', '${
                    e.title
                  }')" class="bg-indigo-600 text-white px-3 py-2 rounded-xl text-[10px] font-black">LOGS</button>
                                <button onclick="adminLogic.deleteEvent('${
                                  d.id
                                }')" class="bg-red-50 text-red-600 px-3 py-2 rounded-xl text-[10px] font-black">ERASE</button>
                            </td>
                        </tr>`;
                })
                .join("");
            });
        },
        // Updated for Task 4: Admin Event Creation Modes
        saveEvent: async function (e) {
          e.preventDefault();
          const isAppMode = document.getElementById("admin-reg-mode").checked;
          
          const d = {
            title: document.getElementById("admin-title").value,
            type: document.getElementById("admin-type").value,
            poster: document.getElementById("admin-poster").value,
            date: document.getElementById("admin-date").value,
            venue: document.getElementById("admin-venue").value,
            description: document.getElementById("admin-desc").value,
            regType: isAppMode ? 'application' : 'direct', // NEW FIELD
            createdAt:
              firebase.firestore.FieldValue.serverTimestamp(),
          };
          await db.collection("events").add(d);
          
          // Task 2: Broadcast Notification
          notifLogic.broadcast(`New Event: ${d.title}`, 'event');
          
          ui.closeModal("event-modal");
          ui.showToast("Event Matrix Initialized", "success");
        },
        deleteEvent: async function (id) {
          if (
            confirm(
              "Confirm destructive deletion of this event node?"
            )
          ) {
            await db.collection("events").doc(id).delete();
            ui.showToast("Node Erased", "info");
          }
        },
        // Updated for Task 4: Approval Workflow
        loadRegistrations: async function (id, title) {
          document.getElementById("reg-event-title").innerText =
            title;
          ui.openModal("reg-viewer-modal");
          
          // Real-time listener for registration status updates
          db.collection("registrations")
            .where("eventId", "==", id)
            .onSnapshot(snap => {
                const tbody = document.getElementById("reg-list-body");
                if(snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="3" class="p-6 text-center italic text-slate-400">No records found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = snap.docs
                .map((doc) => {
                  const r = doc.data();
                  // Logic to show Approve button if pending
                  const isPending = r.status === 'pending';
                  const actionBtn = isPending ? 
                    `<button onclick="adminLogic.approveReg('${doc.id}', '${r.userId}')" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-[9px] font-black hover:bg-indigo-700">APPROVE</button>` :
                    `<span class="text-indigo-500">${r.checkedIn ? "CHECKED-IN" : "AUTHORIZED"}</span>`;
                  
                  return `<tr class="border-b dark:border-slate-800"><td class="p-6 font-black">${
                    r.name
                  }</td><td class="p-6 text-slate-500">
                    <p>${r.email || "N/A"}</p>
                    ${r.reason ? `<p class="text-[10px] italic text-slate-400 mt-1">"${r.reason}"</p>` : ''}
                  </td><td class="p-6 text-right font-black uppercase">
                    ${actionBtn}
                  </td></tr>`;
                })
                .join("");
            });
        },
        approveReg: async function(regId, userId) {
            await db.collection("registrations").doc(regId).update({
                status: 'confirmed'
            });
            // Task 2: Notify User
            notifLogic.send(userId, "Your event application has been APPROVED!", "success");
            ui.showToast("Application Approved", "success");
        }
      };

      // SCANNER LOGIC
      window.scannerLogic = {
        start: function () {
          const res = document.getElementById("scan-result");
          res.classList.add("hidden");
          if (html5QrScanner) this.stop();
          html5QrScanner = new Html5Qrcode("reader");
          html5QrScanner
            .start(
              { facingMode: "environment" },
              { fps: 20, qrbox: 250 },
              (txt) => this.validate(txt)
            )
            .catch((err) =>
              ui.showToast("Optical Hardware Error: " + err, "error")
            );
        },
        validate: async function (id) {
          const res = document.getElementById("scan-result");
          res.classList.remove("hidden");
          res.className =
            "mt-8 p-6 rounded-2xl font-black bg-indigo-50 text-indigo-700 animate-pulse";
          res.innerText = "AUTHENTICATING...";
          try {
            const doc = await db
              .collection("registrations")
              .doc(id)
              .get();
            if (!doc.exists) {
              res.className =
                "mt-8 p-6 rounded-2xl bg-red-50 text-red-600";
              res.innerText = "INVALID CREDENTIALS";
              return;
            }
            const d = doc.data();
            
            // Check status for applications
            if (d.status === 'pending') {
                res.className = "mt-8 p-6 rounded-2xl bg-orange-50 text-orange-600";
                res.innerText = "PENDING APPROVAL";
                return;
            }

            if (d.checkedIn) {
              res.className =
                "mt-8 p-6 rounded-2xl bg-orange-50 text-orange-600";
              res.innerText = "ID ALREADY SCANNED";
            } else {
              await db
                .collection("registrations")
                .doc(id)
                .update({ checkedIn: true });
              res.className =
                "mt-8 p-6 rounded-2xl bg-green-50 text-green-700 animate-bounce";
              res.innerText = "WELCOME, " + d.name.toUpperCase();
              ui.celebrate();
            }
          } catch (e) {
            res.innerText = "Validation Error: " + e.message;
          }
        },
        stop: function () {
          if (html5QrScanner) {
            html5QrScanner.stop();
            html5QrScanner = null;
          }
        },
      };

      // TEAM LOGIC
      window.teamLogic = {
        init: function () {
          db.collection("teamfinder")
            .orderBy("createdAt", "desc")
            .onSnapshot((s) => {
              state.posts = s.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              this.render(state.posts);
            });
        },
        render: function (list) {
          const grid = document.getElementById("team-grid");
          grid.innerHTML = list
            .map((p) => {
              const skills = Array.isArray(p.skills)
                ? p.skills
                : (p.skills || "")
                    .split(",")
                    .map((s) => s.trim())
                    .filter((s) => s);
              return `
                    <div class="glass p-8 rounded-3xl dark:bg-slate-800/50 border dark:border-slate-700 shadow-sm transition hover:shadow-2xl">
                        <div class="flex justify-between items-start mb-4">
                            <div><h4 class="font-black text-indigo-600">${
                              p.userName
                            }</h4><p class="text-[9px] font-black uppercase text-slate-400">Targeting: ${
                p.lookingFor
              }</p></div>
                            <div class="flex gap-2">
                                ${
                                  state.user?.uid === p.userId ||
                                  state.isAdmin
                                    ? `<button onclick="teamLogic.editPost('${p.id}')" class="text-[9px] font-black uppercase text-indigo-500 border border-indigo-100 dark:border-indigo-900 px-2 py-1 rounded-lg">Update</button>`
                                    : ""
                                }
                                ${
                                  state.user?.uid === p.userId ||
                                  state.isAdmin
                                    ? `<button onclick="teamLogic.deletePost('${p.id}')" class="text-[9px] font-black uppercase text-red-500 border border-red-100 dark:border-red-900 px-2 py-1 rounded-lg">del</button>`
                                    : ""
                                }
                                ${
                                  state.user?.uid !== p.userId
                                    ? `<button onclick="teamLogic.openJoin('${p.id}','${p.userId}')" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-lg">CONNECT</button>`
                                    : ""
                                }
                            </div>
                        </div>
                        <p class="text-sm italic mb-6 text-slate-600 dark:text-slate-300">"${
                          p.description
                        }"</p>
                        <div class="flex flex-wrap gap-2">${skills
                          .map(
                            (s) =>
                              `<span class="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-lg text-[8px] font-black uppercase">${s}</span>`
                          )
                          .join("")}</div>
                    </div>`;
            })
            .join("");
        },
        openCreateModal: () => {
          if (!state.user) return ui.openModal("auth-modal");
          document.getElementById("post-id").value = "";
          ui.openModal("post-modal");
        },
        editPost: (id) => {
          const p = state.posts.find((x) => x.id === id);
          if (!p) return;
          document.getElementById("post-id").value = id;
          document.getElementById("post-looking").value =
            p.lookingFor;
          document.getElementById("post-desc").value = p.description;
          document.getElementById("post-skills").value =
            Array.isArray(p.skills) ? p.skills.join(", ") : p.skills;
          document.getElementById("post-contact").value = p.contact;
          ui.openModal("post-modal");
        },
        savePost: async function (e) {
          e.preventDefault();
          const d = {
            userId: state.user.uid,
            userName: state.user.displayName || "Innovator",
            lookingFor: document.getElementById("post-looking").value,
            description: document.getElementById("post-desc").value,
            skills: document.getElementById("post-skills").value,
            contact: document.getElementById("post-contact").value,
            createdAt:
              firebase.firestore.FieldValue.serverTimestamp(),
          };
          const id = document.getElementById("post-id").value;
          if (id) await db.collection("teamfinder").doc(id).update(d);
          else await db.collection("teamfinder").add(d);
          ui.closeModal("post-modal");
          ui.showToast("Intelligence Logged", "success");
        },
        deletePost: async (id) => {
          if (confirm("Confirm scrub of this operational listing?"))
            await db.collection("teamfinder").doc(id).delete();
        },
        openJoin: (pid, oid) => {
          if (!state.user) return ui.openModal("auth-modal");
          if (state.isAdmin) {
            const cid = [state.user.uid, oid].sort().join("_");
            chatLogic.open(cid);
            ui.showToast(
              "Admin Override: Communication Link Established",
              "success"
            );
            return;
          }
          document.getElementById("join-post-id").value = pid;
          document.getElementById("join-post-owner-id").value = oid;
          ui.openModal("join-modal");
        },
        submitJoin: async function (e) {
          e.preventDefault();
          const d = {
            postId: document.getElementById("join-post-id").value,
            postOwnerId: document.getElementById("join-post-owner-id")
              .value,
            requesterId: state.user.uid,
            name: document.getElementById("join-name").value,
            msg: document.getElementById("join-msg").value,
            contact: document.getElementById("join-contact").value,
            status: "Pending",
            timestamp:
              firebase.firestore.FieldValue.serverTimestamp(),
          };
          await db.collection("team_requests").add(d);
          
          // Task 2: Notify Post Owner
          notifLogic.send(d.postOwnerId, `New Team Request from ${d.name}`, "alert");
          
          ui.closeModal("join-modal");
          ui.showToast("Transmission Successful", "success");
        },
        // NEW Task 3: Accept/Reject Logic
        updateRequest: async function(reqId, status, requesterId) {
            await db.collection("team_requests").doc(reqId).update({ status: status });
            
            // Send Notification
            if(status === 'Accepted') {
                notifLogic.send(requesterId, "Your team request was ACCEPTED! üéâ", "success");
            } else {
                notifLogic.send(requesterId, "Your team request was declined.", "alert");
            }
            ui.showToast(`Request ${status}`, status === 'Accepted' ? 'success' : 'info');
        },
        viewApplicant: async function (uid) {
          const uDoc = await db.collection("users").doc(uid).get();
          if (!uDoc.exists)
            return ui.showToast("Identity not found", "error");
          const u = uDoc.data();
          const skills = Array.isArray(u.skills)
            ? u.skills
            : (u.skills || "").split(",").filter((s) => s.trim());

          document.getElementById(
            "applicant-detail-content"
          ).innerHTML = `
                    <div class="text-center mb-8">
                        <div class="w-24 h-24 rounded-3xl bg-indigo-500 mx-auto flex items-center justify-center text-white text-3xl font-black mb-4">
                            ${(u.name || "U")[0].toUpperCase()}
                        </div>
                        <h4 class="text-2xl font-black dark:text-white">${
                          u.name || "Innovator"
                        }</h4>
                        <p class="text-indigo-500 font-bold">${
                          u.dept || "N/A"
                        } ‚Ä¢ ${u.year || "N/A"}</p>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <p class="text-[9px] font-black text-slate-400 uppercase mb-2">Capabilities</p>
                            <div class="flex flex-wrap gap-2">
                                ${
                                  skills
                                    .map(
                                      (s) =>
                                        `<span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-[10px] font-black uppercase">${s.trim()}</span>`
                                    )
                                    .join("") ||
                                  '<p class="text-xs italic">Undefined</p>'
                                }
                            </div>
                        </div>
                        <div>
                            <p class="text-[9px] font-black text-slate-400 uppercase mb-2">Biography</p>
                            <p class="text-sm dark:text-slate-300 italic">"${
                              u.interests || "No briefing available."
                            }"</p>
                        </div>
                        <div class="pt-6 border-t dark:border-slate-800 flex justify-center gap-4">
                            ${
                              u.github
                                ? `<a href="${u.github}" target="_blank" class="text-slate-400 hover:text-slate-900 dark:hover:text-white transition">CODE</a>`
                                : ""
                            }
                            ${
                              u.linkedin
                                ? `<a href="${u.linkedin}" target="_blank" class="text-indigo-400 hover:text-indigo-600 transition">LINKEDIN</a>`
                                : ""
                            }
                        </div>
                    </div>
                `;
          ui.openModal("applicant-modal");
        },
      };

      // CHAT LOGIC
      window.chatLogic = {
        open: function (cid) {
          state.activeChatId = cid;
          ui.openModal("chat-modal");
          this.load(cid);
        },
        load: function (cid) {
          const box = document.getElementById("chat-messages");
          box.innerHTML = '<div class="loader m-auto"></div>';
          unsubscribeChat?.();
          unsubscribeChat = db
            .collection("chats")
            .doc(cid)
            .collection("messages")
            .orderBy("timestamp", "asc")
            .onSnapshot((s) => {
              box.innerHTML = s.docs
                .map((doc) => {
                  const m = doc.data();
                  return `<div class="chat-bubble ${
                    m.senderId === state.user.uid
                      ? "chat-sent"
                      : "chat-received"
                  } animate-reveal">${m.text}</div>`;
                })
                .join("");
              box.scrollTop = box.scrollHeight;
            });
        },
        sendMessage: async function (e) {
          e.preventDefault();
          const i = document.getElementById("chat-input");
          const t = i.value.trim();
          if (!t) return;
          i.value = "";
          await db
            .collection("chats")
            .doc(state.activeChatId)
            .collection("messages")
            .add({
              senderId: state.user.uid,
              text: t,
              timestamp:
                firebase.firestore.FieldValue.serverTimestamp(),
            });
          
          // Task 2: Notify Recipient logic (Complex because we don't know recipient ID easily in simple structure)
          // Simplified: We assume chat is 2 people. 
        },
      };

      // AUTH LOGIC
      const authLogic = {
        init: function () {
          auth.onAuthStateChanged((user) => {
            state.user = user;
            const admins = [
              "admin@campusvibe.com",
              "bandla6302102778@gmail.com",
              "desettylahariprasanna@gmail.com",
            ];
            if (user) {
              state.isAdmin = admins.includes(user.email);
              document
                .getElementById("btn-login")
                .classList.add("hidden");
              document
                .getElementById("user-logged-in")
                .classList.remove("hidden");
              document
                .getElementById("nav-link-dashboard")
                .classList.remove("hidden");
              if (state.isAdmin)
                document
                  .getElementById("nav-link-admin")
                  .classList.remove("hidden");
              profileLogic.refresh();
              this.syncRegistrations();
              notifLogic.init(); // Start notification listeners
            } else {
              document
                .getElementById("btn-login")
                .classList.remove("hidden");
              document
                .getElementById("user-logged-in")
                .classList.add("hidden");
              document
                .getElementById("nav-link-dashboard")
                .classList.add("hidden");
              document
                .getElementById("nav-link-admin")
                .classList.add("hidden");
            }
            document.getElementById("app-loader").style.opacity = "0";
            setTimeout(() => {
              if (document.getElementById("app-loader"))
                document.getElementById("app-loader").remove();
            }, 600);
          });
        },
        syncRegistrations: function () {
          if (!state.user) return;
          db.collection("registrations")
            .where("userId", "==", state.user.uid)
            .onSnapshot((s) => {
              state.userRegistrations = s.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              dashboardLogic.renderTickets();
              ui.animateCounter(
                "stat-events-joined",
                state.userRegistrations.length
              );
            });
        },
        googleLogin: () => {
          const provider = new firebase.auth.GoogleAuthProvider();

          // üî• Force Gmail chooser every time
          provider.setCustomParameters({
            prompt: "select_account",
          });

          return auth
            .signInWithPopup(provider)
            .then(() => ui.closeModal("auth-modal"));
        },
        logout: () => {
          auth.signOut().then(() => {
            if (window.google?.accounts?.id) {
              google.accounts.id.disableAutoSelect();
            }
            state.user = null;
            state.isAdmin = false;
            ui.showToast("Logged out", "info");
          });
        },
        handleSubmit: async (e) => {
          e.preventDefault();
          const em = document.getElementById("auth-email").value;
          const ps = document.getElementById("auth-password").value;
          try {
            await auth.signInWithEmailAndPassword(em, ps);
            ui.closeModal("auth-modal");
          } catch (err) {
            await auth
              .createUserWithEmailAndPassword(em, ps)
              .then(() => ui.closeModal("auth-modal"))
              .catch((e) => ui.showToast(e.message, "error"));
          }
        },
      };

      // PROFILE LOGIC
      window.profileLogic = {
        refresh: async function () {
          if (!state.user) return;
          const d =
            (
              await db.collection("users").doc(state.user.uid).get()
            ).data() || {};
          document.getElementById("user-initial").innerText =
            (d.name || state.user.email || "U")[0].toUpperCase();
          document.getElementById("dash-prof-initial").innerText =
            (d.name || state.user.email || "U")[0].toUpperCase();
          document.getElementById("dash-prof-name").innerText =
            d.name || "Innovator";
          document.getElementById(
            "dash-prof-subtitle"
          ).innerText = `${d.dept || "N/A"} ‚Ä¢ ${d.year || "N/A"}`;

          const skills = Array.isArray(d.skills)
            ? d.skills
            : (d.skills || "").split(",").filter((s) => s.trim());
          document.getElementById("dash-prof-skills").innerHTML =
            skills
              .map(
                (s) =>
                  `<span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-[10px] font-black uppercase">${s.trim()}</span>`
              )
              .join("") ||
            '<p class="text-xs text-slate-400">Capabilities Undefined</p>';

          let completeness = 0;
          if (d.name) completeness += 20;
          if (d.dept) completeness += 10;
          if (d.year) completeness += 10;
          if (skills.length > 0) completeness += 20;
          if (d.interests) completeness += 20;
          if (d.linkedin || d.github) completeness += 20;

          state.profileCompleteness = completeness;
          document.getElementById("prof-integrity-bar").style.width =
            completeness + "%";

          const percentEl = document.getElementById(
            "prof-integrity-percent"
          );
          if (percentEl) percentEl.innerText = completeness + "%";

          const rankEl = document.getElementById("prof-growth-rank");
          if (completeness < 40) rankEl.innerText = "Initiate";
          else if (completeness < 80)
            rankEl.innerText = "Rising Star";
          else rankEl.innerText = "Alpha Innovator";

          document.getElementById("prof-name").value = d.name || "";
          document.getElementById("prof-dept").value = d.dept || "";
          document.getElementById("prof-year").value = d.year || "";
          document.getElementById("prof-skills").value =
            Array.isArray(d.skills)
              ? d.skills.join(", ")
              : d.skills || "";
          document.getElementById("prof-interests").value =
            d.interests || "";
          document.getElementById("prof-linkedin").value =
            d.linkedin || "";
          document.getElementById("prof-github").value =
            d.github || "";
        },
        saveProfile: async function (e) {
          e.preventDefault();
          const d = {
            name: document.getElementById("prof-name").value,
            dept: document.getElementById("prof-dept").value,
            year: document.getElementById("prof-year").value,
            skills: document.getElementById("prof-skills").value,
            interests:
              document.getElementById("prof-interests").value,
            linkedin: document.getElementById("prof-linkedin").value,
            github: document.getElementById("prof-github").value,
            updatedAt:
              firebase.firestore.FieldValue.serverTimestamp(),
          };
          await db
            .collection("users")
            .doc(state.user.uid)
            .set(d, { merge: true });
          ui.closeModal("profile-modal");
          ui.showToast("Identity Core Updated", "success");
          this.refresh();
        },
        openMyProfile: () => ui.openModal("profile-modal"),
      };

      // DASHBOARD LOGIC
      window.dashboardLogic = {
        switchTab: function (t) {
          document
            .querySelectorAll(".dashboard-tab")
            .forEach((el) => el.classList.remove("active"));
          document
            .getElementById(`dash-${t}`)
            .classList.add("active");
          document
            .querySelectorAll(".sidebar-link")
            .forEach((el) => el.classList.remove("active"));
          document
            .getElementById(`tab-btn-${t}`)
            .classList.add("active");

          if (t === "inbox" || t === "posts")
            dashboardLogic.loadData();
        },
        loadData: async function () {
          if (!state.user) return;

          // Task 3: Updated Inbox Logic (Accept/Reject)
          db.collection("team_requests")
            .where("postOwnerId", "==", state.user.uid)
            .onSnapshot((reqs) => {
              const incomingBox =
                document.getElementById("inbox-incoming");
              document.getElementById("badge-incoming").innerText =
                reqs.size;

              incomingBox.innerHTML = reqs.empty
                ? '<p class="text-center italic text-slate-400 py-10">No incoming transmissions</p>'
                : reqs.docs
                    .map((d) => {
                      const r = d.data();
                      const cid = [state.user.uid, r.requesterId]
                        .sort()
                        .join("_");
                      
                      const actions = r.status === "Pending" ? `
                        <button onclick="teamLogic.updateRequest('${d.id}', 'Accepted', '${r.requesterId}')" class="flex-1 bg-green-100 text-green-700 px-3 py-2 rounded-xl text-[10px] font-black hover:bg-green-200">ACCEPT</button>
                        <button onclick="teamLogic.updateRequest('${d.id}', 'Rejected', '${r.requesterId}')" class="flex-1 bg-red-100 text-red-600 px-3 py-2 rounded-xl text-[10px] font-black hover:bg-red-200">REJECT</button>
                      ` : `<span class="flex-1 text-center py-2 text-[10px] font-black uppercase ${r.status === 'Accepted' ? 'text-green-600' : 'text-red-500'}">${r.status}</span>`;

                      return `
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl border dark:border-slate-700 shadow-sm flex flex-col justify-between items-start gap-4 animate-reveal">
                            <div class="w-full">
                                <div class="flex justify-between items-start w-full">
                                    <h4 class="font-black text-indigo-600 mb-1">${
                                      r.name
                                    }</h4>
                                    
                                </div>
                                <p class="text-xs italic text-slate-500 mb-2">"${
                                  r.msg
                                }"</p>
                                <div class="flex items-center gap-2">
                                     <span class="bg-slate-100 dark:bg-slate-900 px-2 py-0.5 rounded-lg text-[8px] font-black uppercase text-slate-400">${
                                       r.timestamp
                                         ?.toDate()
                                         .toLocaleString() || "N/A"
                                     }</span>
                                     <span class="text-[8px] font-black uppercase text-indigo-400">Verified Contact</span>
                                </div>
                            </div>
                            <div class="flex gap-2 w-full">
                                <button onclick="teamLogic.viewApplicant('${
                                  r.requesterId
                                }')" class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-3 py-2 rounded-xl text-[10px] font-black">VIEW</button>
                                ${actions}
                                <button onclick="chatLogic.open('${cid}')" class="bg-indigo-600 text-white px-3 py-2 rounded-xl text-[10px] font-black shadow-lg">CHAT</button>
                            </div>
                        </div>`;
                    })
                    .join("");
            });

          db.collection("team_requests")
            .where("requesterId", "==", state.user.uid)
            .onSnapshot((sent) => {
              const sentBox = document.getElementById("inbox-sent");
              ui.animateCounter("stat-apps-sent", sent.size);

              sentBox.innerHTML = sent.empty
                ? '<p class="text-center italic text-slate-400 py-10">No sent transmissions</p>'
                : sent.docs
                    .map((d) => {
                      const s = d.data();
                      const statusColor =
                        s.status === "Accepted"
                          ? "text-green-500"
                          : s.status === "Rejected"
                          ? "text-red-500"
                          : "text-orange-500";
                      return `
                        <div class="bg-slate-50 dark:bg-slate-800/30 p-6 rounded-3xl border border-dashed border-slate-200 dark:border-slate-700 flex justify-between items-center opacity-80 group hover:opacity-100 transition">
                            <div>
                                <p class="text-[9px] font-black uppercase text-slate-400 mb-1">Sent Request</p>
                                <h4 class="font-black dark:text-white group-hover:text-indigo-600 transition">${
                                  s.name
                                }</h4>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] font-black uppercase ${statusColor}">${
                        s.status || "Pending"
                      }</span>
                                <p class="text-[8px] text-slate-400 mt-1">${
                                  s.timestamp
                                    ?.toDate()
                                    .toLocaleDateString() || "N/A"
                                }</p>
                            </div>
                        </div>`;
                    })
                    .join("");
            });

          const myPosts = await db
            .collection("teamfinder")
            .where("userId", "==", state.user.uid)
            .get();
          document.getElementById("profile-posts").innerHTML =
            myPosts.empty
              ? '<p class="text-center italic text-slate-400 py-10">No active operational listings</p>'
              : myPosts.docs
                  .map((d) => {
                    const p = d.data();
                    return `<div class="bg-white dark:bg-slate-800 p-6 rounded-3xl border dark:border-slate-700 shadow-sm flex justify-between items-center transform hover:scale-[1.01] transition"><div><p class="font-black dark:text-white">${
                      p.lookingFor
                    }</p><p class="text-[10px] uppercase text-slate-400">Deployed: ${
                      p.createdAt?.toDate().toLocaleDateString() ||
                      "N/A"
                    }</p></div><button onclick="teamLogic.editPost('${
                      d.id
                    }')" class="text-indigo-600 font-black text-xs hover:underline">UPDATE</button></div>`;
                  })
                  .join("");
        },
        renderTickets: function () {
          const box = document.getElementById("profile-tickets");
          
          // Filter to show only Confirmed tickets in dashboard (Hide pending applications)
          const validTickets = state.userRegistrations.filter(r => r.status === 'confirmed' || !r.status /* legacy support */);
          const pendingTickets = state.userRegistrations.filter(r => r.status === 'pending');

          if (validTickets.length === 0 && pendingTickets.length === 0) {
            box.innerHTML =
              '<div class="col-span-full text-center p-12 bg-slate-50 dark:bg-slate-800/50 rounded-3xl border border-dashed dark:border-slate-700"><p class="italic text-slate-400">No active access passes detected.</p></div>';
            return;
          }

          let html = "";
          
          // Pending Section
          if(pendingTickets.length > 0) {
             html += pendingTickets.map(r => `
                <div class="bg-orange-50 dark:bg-orange-900/10 p-6 rounded-3xl border border-orange-100 dark:border-orange-800/30 shadow-sm flex items-center justify-between opacity-75">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center text-orange-600 font-black text-xl">‚è≥</div>
                        <div>
                            <h4 class="font-black dark:text-white text-md leading-tight">${r.eventTitle}</h4>
                            <p class="text-[10px] font-bold text-orange-500 uppercase tracking-tighter mt-1">Application Pending Approval</p>
                        </div>
                    </div>
                </div>
             `).join("");
          }

          html += validTickets
            .map(
              (r) => `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl border dark:border-slate-700 shadow-sm flex items-center justify-between group transition hover:shadow-xl">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 font-black text-xl">
                                üéüÔ∏è
                            </div>
                            <div>
                                <h4 class="font-black dark:text-white text-md leading-tight">${
                                  r.eventTitle
                                }</h4>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter mt-1">${
                                  r.checkedIn
                                    ? "‚úì Authorization Confirmed"
                                    : "‚Ä¢ Pending Physical Sync"
                                }</p>
                            </div>
                        </div>
                        <button onclick="dashboardLogic.openTicketModal('${
                          r.id
                        }')" class="bg-indigo-600 text-white px-5 py-2.5 rounded-2xl text-[10px] font-black shadow-lg hover:bg-indigo-700 transition transform hover:scale-105 active:scale-95">VIEW PASS</button>
                    </div>`
            )
            .join("");
            
            box.innerHTML = html;
        },
        openTicketModal: function (regId) {
          const reg = state.userRegistrations.find(
            (x) => x.id === regId
          );
          if (!reg) return;

          const nameEl = document.getElementById("ticket-event-name");
          const userEl = document.getElementById("ticket-user-name");
          const idEl = document.getElementById("ticket-id-display");
          const qrContainer = document.getElementById(
            "ticket-qr-container"
          );

          nameEl.innerText = reg.eventTitle;
          userEl.innerText = reg.name || "Innovator Node";
          idEl.innerText = `ACCESS-UID: ${reg.id.toUpperCase()}`;

          qrContainer.innerHTML = "";
          new QRCode(qrContainer, {
            text: reg.id,
            width: 180,
            height: 180,
            colorDark: "#1e1b4b",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H,
          });

          ui.openModal("ticket-modal");
          ui.showToast("Synchronizing Access Ticket...", "success");
        },
      };

      // EVENTS LOGIC
      window.eventsLogic = {
        init: function () {
          db.collection("events")
            .orderBy("createdAt", "desc")
            .onSnapshot((s) => {
              state.events = s.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              this.render(state.events);
            });
            
          // Task 1: Auto Vanish Timer (Runs every 60s)
          setInterval(() => {
             this.render(state.events);
          }, 60000);
        },
        render: function (list) {
          const grid = document.getElementById("events-grid");
          // Task 1: Filter Expired Events
          const now = new Date();
          const activeList = list.filter(e => {
             // If no date, show it. If date, check if future.
             return !e.date || new Date(e.date) > now;
          });

          grid.innerHTML = activeList.length === 0 ? 
            '<div class="col-span-full text-center py-20"><h3 class="text-2xl font-black text-slate-300 uppercase">No Active Modules</h3></div>' :
            activeList
            .map(
              (e) => `
                    <div onclick="eventsLogic.openDetail('${
                      e.id
                    }')" class="glass rounded-[2.5rem] overflow-hidden cursor-pointer hover:scale-[1.03] transition-all bg-white dark:bg-slate-800/50 group shadow-lg">
                        <div class="relative overflow-hidden h-56">
                            <img src="${
                              e.poster ||
                              "https://placehold.co/600x400?text=" +
                                encodeURIComponent(e.title)
                            }" class="h-full w-full object-cover transition duration-700 group-hover:scale-110">
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 to-transparent opacity-0 group-hover:opacity-100 transition duration-500 flex items-end p-8">
                                <span class="text-white text-xs font-black uppercase tracking-widest">Examine Details</span>
                            </div>
                        </div>
                        <div class="p-8">
                            <span class="text-indigo-600 font-black text-[9px] uppercase tracking-widest">${
                              e.type
                            }</span>
                            <h3 class="text-xl font-black mb-2 dark:text-white mt-1 group-hover:text-indigo-600 transition">${
                              e.title
                            }</h3>
                            <p class="text-[10px] uppercase font-black text-slate-400">${
                              e.date ? new Date(e.date).toLocaleDateString() : "TBA"
                            } ‚Ä¢ ${e.venue}</p>
                        </div>
                    </div>`
            )
            .join("");
        },
        filter: (t) => {
           // Filter needs to apply the same logic
           const filtered = t === "All" ? state.events : state.events.filter((x) => x.type === t);
           // Task 1: Re-filter for time happens inside render()
           eventsLogic.render(filtered);
        },
        openDetail: (id) => {
          const e = state.events.find((x) => x.id === id);
          if (!e) return;
          
          // Task 1: Check Expiry inside Detail View
          const isExpired = e.date && new Date(e.date) < new Date();
          
          const regRecord = state.userRegistrations.find(
            (r) => r.eventId === id
          );
          
          let actionButton = "";
          
          if (isExpired) {
              actionButton = `<button class="w-full bg-slate-200 text-slate-500 py-5 rounded-3xl font-black cursor-not-allowed">EVENT EXPIRED</button>`;
          } else if (regRecord) {
              if (regRecord.status === 'pending') {
                  actionButton = `<button class="w-full bg-orange-100 text-orange-600 py-5 rounded-3xl font-black cursor-default border-2 border-orange-200">APPLICATION UNDER REVIEW</button>`;
              } else {
                  actionButton = `<button class="w-full bg-green-100 text-green-700 py-5 rounded-3xl font-black cursor-default border-2 border-green-200">ACCESS PERMISSION GRANTED</button>`;
              }
          } else {
              // Task 4: Check if Application Mode or Direct
              if(e.regType === 'application') {
                  actionButton = `<button onclick="eventsLogic.openAppForm('${e.id}')" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black shadow-2xl shadow-indigo-500/30 transform hover:scale-[1.02] active:scale-[0.98] transition">APPLY FOR ACCESS</button>`;
              } else {
                  actionButton = `<button onclick="eventsLogic.register('${e.id}')" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black shadow-2xl shadow-indigo-500/30 transform hover:scale-[1.02] active:scale-[0.98] transition">CLAIM ACCESS TICKET</button>`;
              }
          }

          document.getElementById("detail-content").innerHTML = `
                    <div class="relative h-80">
                        <img src="${
                          e.poster || "https://placehold.co/800x400"
                        }" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent"></div>
                        <div class="absolute bottom-10 left-10 right-10">
                             <span class="bg-indigo-600 text-white text-[10px] px-3 py-1 rounded-full font-black uppercase mb-3 inline-block">${
                               e.type
                             }</span>
                             <h2 class="text-4xl font-black text-white mb-2">${
                               e.title
                             }</h2>
                        </div>
                    </div>
                    <div class="p-10 dark:bg-slate-900">
                        <div class="grid grid-cols-2 gap-6 mb-10">
                            <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border dark:border-slate-700">
                                <p class="text-[9px] font-black text-slate-400 uppercase">Chronology</p>
                                <p class="font-bold text-sm dark:text-white">üìÖ ${
                                  e.date ? new Date(e.date).toLocaleString() : "TBA"
                                }</p>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border dark:border-slate-700">
                                <p class="text-[9px] font-black text-slate-400 uppercase">Coordinates</p>
                                <p class="font-bold text-sm dark:text-white">üìç ${
                                  e.venue
                                }</p>
                            </div>
                        </div>
                        <div class="prose dark:prose-invert max-w-none">
                            <p class="text-slate-600 dark:text-slate-300 mb-10 whitespace-pre-line leading-relaxed text-lg">${
                              e.description
                            }</p>
                        </div>
                        ${actionButton}
                    </div>`;
          ui.openModal("detail-modal");
        },
        register: async function (id) {
          if (!state.user) return ui.openModal("auth-modal");
          const e = state.events.find((x) => x.id === id);
          const regData = {
            eventId: id,
            eventTitle: e.title,
            userId: state.user.uid,
            name:
              state.user.displayName ||
              (
                await db.collection("users").doc(state.user.uid).get()
              ).data()?.name ||
              "Innovator",
            email: state.user.email,
            checkedIn: false,
            status: 'confirmed', // Direct mode = confirmed
            timestamp:
              firebase.firestore.FieldValue.serverTimestamp(),
          };
          await db.collection("registrations").add(regData);
          
          // Task 2: Notify User
          notifLogic.send(state.user.uid, `Ticket Confirmed: ${e.title}`, 'success');
          
          ui.closeModal("detail-modal");
          ui.showToast("Access Ticket Secured", "success");
          ui.celebrate();
        },
        // NEW: Task 4 Application Logic
        openAppForm: function(id) {
            if (!state.user) return ui.openModal("auth-modal");
            document.getElementById("app-event-id").value = id;
            ui.openModal("app-form-modal");
        },
        submitApplication: async function(e) {
            e.preventDefault();
            const id = document.getElementById("app-event-id").value;
            const reason = document.getElementById("app-reason").value;
            const evt = state.events.find(x => x.id === id);
            
            const regData = {
                eventId: id,
                eventTitle: evt.title,
                userId: state.user.uid,
                name: state.user.displayName || "Innovator",
                email: state.user.email,
                checkedIn: false,
                status: 'pending', // App mode = pending
                reason: reason,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection("registrations").add(regData);
            
            ui.closeModal("app-form-modal");
            ui.closeModal("detail-modal");
            ui.showToast("Application Submitted for Review", "info");
        }
      };

      const router = {
        navigate: (id) => {
          document
            .querySelectorAll(".view-section")
            .forEach((el) => el.classList.remove("active"));
          document
            .getElementById(`view-${id}`)
            ?.classList.add("active");
          if (id === "admin") adminLogic.init();
          if (id === "dashboard") {
            dashboardLogic.loadData();
            profileLogic.refresh();
          }
          window.scrollTo({ top: 0, behavior: "smooth" });
        },
      };

      /**
       * 3D BACKGROUND INITIALIZATION
       */
      function init3D() {
        const container = document.getElementById("canvas-container");
        if (!container) return;
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        const renderer = new THREE.WebGLRenderer({
          alpha: true,
          antialias: true,
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        const geo = new THREE.BufferGeometry();
        const count = 1200;
        const pos = new Float32Array(count * 3);
        for (let i = 0; i < count * 3; i++)
          pos[i] = (Math.random() - 0.5) * 80;
        geo.setAttribute(
          "position",
          new THREE.BufferAttribute(pos, 3)
        );

        const mat = new THREE.PointsMaterial({
          size: 0.08,
          color: 0x6366f1,
          transparent: true,
          opacity: 0.4,
          blending: THREE.AdditiveBlending,
        });
        const stars = new THREE.Points(geo, mat);
        scene.add(stars);
        camera.position.z = 25;

        function animate() {
          requestAnimationFrame(animate);
          stars.rotation.y += 0.0005;
          stars.rotation.x += 0.0002;
          renderer.render(scene, camera);
        }
        animate();

        window.addEventListener("resize", () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });
      }

      /**
       * CORE INITIALIZATION
       */
      window.onload = () => {
        console.log("Initializing CampusVibe OS...");
        init3D();
        authLogic.init();
        eventsLogic.init();
        teamLogic.init();
      };
    </script>
    <script>
      // üî• VERY IMPORTANT: disable auto sign-in on page load
      window.addEventListener("load", () => {
        if (window.google?.accounts?.id) {
          google.accounts.id.disableAutoSelect();
        }
      });
    </script>
  </body>
</html>
